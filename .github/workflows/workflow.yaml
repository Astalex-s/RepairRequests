# CI/CD: Build → Push to GHCR → Deploy via SSH
# Trigger: push to master branch
#
# Required GitHub Secrets (Settings → Secrets and variables → Actions):
# ┌──────────────────┬─────────────────────────────────────────────────────────────────┐
# │ Secret           │ Description                                                      │
# ├──────────────────┼─────────────────────────────────────────────────────────────────┤
# │ SSH_HOST         │ Remote server hostname or IP address                              │
# │ SSH_PORT         │ SSH port (e.g. 22)                                                │
# │ SSH_USERNAME     │ SSH login username                                                │
# │ SSH_PRIVATE_KEY  │ Private SSH key (full content, including -----BEGIN/END-----)     │
# │ DEPLOY_PATH      │ Path on server for app (e.g. /opt/repairrequests)                 │
# │ GHCR_TOKEN       │ GitHub PAT with read:packages (for docker login on server)        │
# │ GHCR_USERNAME    │ GitHub username (for docker login on server)                      │
# └──────────────────┴─────────────────────────────────────────────────────────────────┘
# Note: GITHUB_TOKEN is provided automatically; no need to add it for build/push.
#
# Server setup: create DEPLOY_PATH on server, add .env with POSTGRES_*, DATABASE_URL,
# JWT_SECRET_KEY, etc. (see .env.example). Install Docker and Docker Compose.

name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: Build and Push to GHCR
    runs-on: ubuntu-latest
    outputs:
      image-backend: ${{ steps.meta-backend.outputs.tags }}
      image-frontend: ${{ steps.meta-frontend.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (backend)
        id: meta-backend
        run: |
          echo "tags=${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-backend:latest,${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-backend:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-backend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-backend:${{ github.sha }}

      - name: Extract metadata (frontend)
        id: meta-frontend
        run: |
          echo "tags=${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-frontend:latest,${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-frontend:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-frontend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/repairrequests-frontend:${{ github.sha }}

  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare docker-compose for deploy
        run: |
          sed "s/__GHCR_OWNER__/${{ github.repository_owner }}/g" docker-compose.prod.yml > docker-compose.prod.generated.yml

      - name: Copy docker-compose to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.generated.yml"
          target: ${{ secrets.DEPLOY_PATH }}/docker-compose.prod.yml

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker compose -f docker-compose.prod.yml up -d
